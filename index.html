<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@500;600&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS for Excel Export -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --ink: #0f172a;
      --ink-soft: #334155;
      --muted: #64748b;
      --text: #0f172a;
      --text-light: #64748b;
      --primary: #0f766e;
      --primary-dark: #0b5d57;
      --success: #16a34a;
      --warning: #d97706;
      --danger: #dc2626;
      --bg: #f4f7f6;
      --card: #ffffff;
      --border: #e2e8f0;
      --ring: rgba(15, 118, 110, 0.25);
      --shadow-sm: 0 1px 2px rgba(15, 23, 42, 0.06), 0 1px 3px rgba(15, 23, 42, 0.08);
      --shadow-md: 0 10px 30px rgba(15, 23, 42, 0.08);
      --shadow-lg: 0 20px 45px rgba(15, 23, 42, 0.12);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "IBM Plex Sans", "Segoe UI", system-ui, sans-serif;
      background:
        radial-gradient(1200px 500px at 10% -10%, rgba(15, 118, 110, 0.08), transparent 60%),
        radial-gradient(900px 600px at 100% 0%, rgba(15, 23, 42, 0.08), transparent 55%),
        var(--bg);
      color: var(--ink);
      min-height: 100vh;
    }

    h1, .card-title, .modal-title {
      font-family: "Fraunces", "IBM Plex Sans", serif;
      letter-spacing: -0.01em;
    }

    .icon {
      width: 1em;
      height: 1em;
      display: inline-block;
      vertical-align: -0.125em;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .icon-sm {
      width: 0.9em;
      height: 0.9em;
    }

    .icon-lg {
      width: 2rem;
      height: 2rem;
    }

    .icon-muted {
      color: var(--muted);
    }

    .title-icon {
      color: var(--primary);
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    header {
      margin-bottom: 24px;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 12px;
    }

    h1 {
      font-size: 1.7rem;
      color: var(--ink);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    nav {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      padding: 8px;
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid var(--border);
      border-radius: 999px;
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(8px);
    }

    .nav-btn {
      padding: 10px 20px;
      border: 1px solid transparent;
      background: transparent;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      flex: 1;
      min-width: 110px;
      text-align: center;
      color: var(--ink-soft);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .nav-btn .icon {
      width: 1.4em;
      height: 1.4em;
    }

    .nav-btn .icon-analytics {
      width: 1.8em;
      height: 1.8em;
      transform: translateY(0.06em);
    }

    .nav-btn:hover {
      color: var(--primary);
      background: rgba(15, 118, 110, 0.08);
    }

    .nav-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn {
      padding: 10px 16px;
      border: 1px solid transparent;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      box-shadow: var(--shadow-sm);
    }

    .btn .icon {
      width: 1em;
      height: 1em;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-secondary {
      background: white;
      color: var(--ink);
      border-color: var(--border);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.875rem;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 22px;
      margin-bottom: 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-md);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .card-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--ink);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    .list-card {
      background: linear-gradient(180deg, #ffffff 0%, #fbfdfc 100%);
      border-radius: var(--radius-md);
      padding: 16px;
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      border: 1px solid var(--border);
      position: relative;
    }

    .list-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: rgba(15, 118, 110, 0.35);
    }

    .list-card.selected {
      border-color: var(--primary);
      box-shadow: var(--shadow-lg);
    }

    .list-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .list-card-header-info {
      flex: 1;
      min-width: 0;
    }

    .list-card-title {
      font-weight: 600;
      font-size: 1.1rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .list-card-date {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .list-card-stats {
      display: flex;
      gap: 16px;
      font-size: 0.875rem;
      color: var(--muted);
    }

    .stat {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .budget-bar {
      height: 8px;
      background: #e6ecea;
      border-radius: 999px;
      margin-top: 12px;
      overflow: hidden;
    }

    .budget-bar-fill {
      height: 100%;
      border-radius: 999px;
      transition: width 0.3s ease;
    }

    .budget-under {
      background: var(--success);
    }

    .budget-warning {
      background: var(--warning);
    }

    .budget-over {
      background: var(--danger);
    }

    .group-section {
      margin-bottom: 32px;
    }

    /* Updated Group Header Styles for Collapse */
    .group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
      padding: 8px;
      border-radius: 8px 8px 0 0;
    }
    
    .group-header:hover {
        background-color: rgba(0,0,0,0.03);
    }

    .group-title-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .group-title {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--ink-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .chevron {
        transition: transform 0.2s;
        display: inline-block;
        font-size: 0.8rem;
    }
    
    .chevron.rotated {
        transform: rotate(-90deg);
    }

    /* Group Detail View Styles */
    .clickable-group-card {
        cursor: pointer;
    }
    .clickable-group-card .btn {
        position: relative; 
        z-index: 2; /* Ensure buttons sit above the clickable card area */
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      backdrop-filter: blur(6px);
    }

    .modal {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 24px;
      max-width: 520px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--muted);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--ink-soft);
    }

    .modal-section {
      margin-bottom: 18px;
    }

    .field-label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .field-label-row .form-label {
      margin-bottom: 0;
    }

    .info-dot {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--muted);
      font-weight: 700;
      font-size: 0.75rem;
      display: inline-grid;
      place-items: center;
      cursor: help;
      position: relative;
    }

    .info-dot:hover,
    .info-dot:focus-visible {
      color: var(--primary);
      border-color: rgba(15, 118, 110, 0.5);
      outline: none;
    }

    .info-dot::after,
    .info-dot::before {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .info-dot::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 8px);
      right: 0;
      width: min(240px, 70vw);
      background: #0f172a;
      color: #ffffff;
      font-size: 0.75rem;
      line-height: 1.35;
      padding: 8px 10px;
      border-radius: 10px;
      box-shadow: var(--shadow-md);
      transform: translateY(6px);
      z-index: 50;
      text-align: left;
    }

    .info-dot::before {
      content: "";
      position: absolute;
      bottom: 100%;
      right: 10px;
      border: 6px solid transparent;
      border-top-color: #0f172a;
      transform: translateY(6px);
    }

    .info-dot:hover::after,
    .info-dot:hover::before,
    .info-dot:focus-visible::after,
    .info-dot:focus-visible::before {
      opacity: 1;
      transform: translateY(0);
    }

    .price-panel {
      background: #f7faf9;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px;
    }

    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-weight: 600;
      color: var(--ink);
      margin-bottom: 12px;
    }

    .segmented {
      display: flex;
      gap: 10px;
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px;
      width: fit-content;
      margin-bottom: 12px;
    }

    .segmented-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      color: var(--ink-soft);
    }

    .segmented-option input:checked + span {
      color: var(--primary);
    }

    .field-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .price-preview {
      text-align: right;
      margin-top: 10px;
      font-weight: 700;
      color: var(--primary);
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 1rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background: #f8fafc;
      color: var(--ink);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--ring);
      background: #ffffff;
    }

    .form-input[type="color"] {
      padding: 6px;
      height: 44px;
      cursor: pointer;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    .item-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .item-card {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: #f8fafc;
      border-radius: var(--radius-sm);
      align-items: center;
      flex-wrap: wrap;
      border: 1px solid var(--border);
    }

    .item-card.todo {
      border-left: 4px solid var(--warning);
    }

    .item-card.purchased {
      border-left: 4px solid var(--success);
    }

    .item-checkbox {
      width: 24px;
      height: 24px;
      cursor: pointer;
      accent-color: var(--success);
      flex-shrink: 0;
    }

    .item-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      flex-shrink: 0;
    }

    .item-image-placeholder {
      width: 60px;
      height: 60px;
      background: var(--border);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      flex-shrink: 0;
    }

    .item-image-placeholder .icon {
      width: 24px;
      height: 24px;
    }

    .item-details {
      flex: 1;
      min-width: 120px;
    }

    .item-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .item-meta {
      font-size: 0.875rem;
      color: var(--muted);
    }

    .item-price {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--primary);
    }

    .item-actions {
      display: flex;
      gap: 8px;
    }

    .tag {
      display: inline-block;
      padding: 4px 8px;
      background: #e2e8f0;
      border-radius: 999px;
      font-size: 0.75rem;
      color: var(--muted);
      font-weight: 600;
      border: 1px solid transparent;
    }

    .tag-group {
      background: rgba(15, 118, 110, 0.12);
      color: var(--primary);
      border-color: rgba(15, 118, 110, 0.25);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .summary-card {
      background: #f8fafc;
      padding: 16px;
      border-radius: var(--radius-sm);
      text-align: center;
      border: 1px solid var(--border);
    }

    .summary-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
    }

    .summary-label {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin: 20px 0;
    }

    .checkbox-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px;
      background: #f8fafc;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      cursor: pointer;
    }

    .checkbox-item:hover {
      background: rgba(15, 118, 110, 0.06);
      border-radius: 6px;
    }

    /* CSS for Bulk Management Features */
    .manage-section {
      margin-bottom: 24px;
      background: #f8fafc;
      border-radius: var(--radius-sm);
      padding: 12px;
      border: 1px solid var(--border);
    }
    .manage-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    .manage-section-title {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }
    .manage-list-item {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding: 10px;
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .manage-list-item:hover {
      border-color: rgba(15, 118, 110, 0.45);
      box-shadow: var(--shadow-sm);
    }
    .manage-checkbox {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        cursor: pointer;
        accent-color: var(--primary);
    }

    /* Bulk Actions Toolbar */
    .bulk-actions-bar {
        margin-top: 8px;
        display: flex;
        gap: 8px;
    }
    
    .btn-block {
        display: block;
        width: 100%;
        text-align: center;
    }
    
    .text-sm {
        font-size: 0.8rem;
    }
    
    .select-toggle {
        font-size: 0.8rem;
        color: var(--primary);
        cursor: pointer;
        text-decoration: underline;
        border: none;
        background: none;
        padding: 0;
    }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--muted);
    }

    .empty-state-icon {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      margin: 0 auto 16px;
      display: grid;
      place-items: center;
      background: rgba(15, 118, 110, 0.1);
      color: var(--primary);
    }

    .empty-state-icon .icon {
      width: 32px;
      height: 32px;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--muted);
      text-decoration: none;
      margin-bottom: 16px;
      cursor: pointer;
      font-weight: 600;
    }

    .back-btn:hover {
      color: var(--primary);
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      left: 0;
      top: 100%;
      background: var(--card);
      min-width: 200px;
      box-shadow: var(--shadow-lg);
      border-radius: var(--radius-sm);
      z-index: 100;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .dropdown-content.show {
      display: block;
    }

    .dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .dropdown-item:hover {
      background: rgba(15, 118, 110, 0.08);
    }

    .hidden {
      display: none !important;
    }
    
    /* Search Features CSS */
    .search-result-item {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: background 0.2s;
    }
    .search-result-item:hover {
        background: var(--bg);
    }
    .search-result-meta {
        font-size: 0.8rem;
        color: var(--muted);
        margin-top: 4px;
        display: flex;
        justify-content: space-between;
    }
    .search-highlight {
        animation: highlight-pulse 2s ease-out;
    }
    @keyframes highlight-pulse {
        0% { background-color: rgba(15, 118, 110, 0.2); box-shadow: 0 0 10px rgba(15, 118, 110, 0.15); }
        100% { background-color: transparent; }
    }

    @media (max-width: 640px) {
      .app {
        padding: 16px;
      }

      h1 {
        font-size: 1.35rem;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .item-card {
        flex-wrap: wrap;
      }

      .item-price {
        width: 100%;
        text-align: right;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid var(--border);
      }

      .item-actions {
        width: 100%;
        justify-content: flex-end;
      }

      .summary-value {
        font-size: 1.1rem;
      }

      .card {
        padding: 16px;
      }

      .card-header {
        flex-direction: column;
        align-items: stretch;
      }

      .card-header .btn {
        width: 100%;
        justify-content: center;
      }

      .field-grid {
        grid-template-columns: 1fr;
      }

      .segmented {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden" aria-hidden="true">
    <symbol id="i-cart" viewBox="0 0 24 24">
      <circle cx="9" cy="20" r="1.5"></circle>
      <circle cx="18" cy="20" r="1.5"></circle>
      <path d="M3 4h2l2.2 10.5a2 2 0 0 0 2 1.5h8.8a2 2 0 0 0 2-1.6l1.5-7.4H7.2"></path>
    </symbol>
    <symbol id="i-search" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="7"></circle>
      <line x1="16.65" y1="16.65" x2="21" y2="21"></line>
    </symbol>
    <symbol id="i-upload" viewBox="0 0 24 24">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
      <path d="M7 10l5-5 5 5"></path>
      <line x1="12" y1="5" x2="12" y2="16"></line>
    </symbol>
    <symbol id="i-download" viewBox="0 0 24 24">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
      <path d="M7 10l5 5 5-5"></path>
      <line x1="12" y1="4" x2="12" y2="15"></line>
    </symbol>
    <symbol id="i-list" viewBox="0 0 24 24">
      <line x1="8" y1="6" x2="20" y2="6"></line>
      <line x1="8" y1="12" x2="20" y2="12"></line>
      <line x1="8" y1="18" x2="20" y2="18"></line>
      <circle cx="4" cy="6" r="1"></circle>
      <circle cx="4" cy="12" r="1"></circle>
      <circle cx="4" cy="18" r="1"></circle>
    </symbol>
    <symbol id="i-folder" viewBox="0 0 24 24">
      <path d="M3 7a2 2 0 0 1 2-2h4l2 2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
    </symbol>
    <symbol id="i-chart" viewBox="0 0 24 24">
      <line x1="4" y1="19" x2="20" y2="19"></line>
      <rect x="6" y="10" width="3" height="7" rx="1"></rect>
      <rect x="11" y="6" width="3" height="11" rx="1"></rect>
      <rect x="16" y="13" width="3" height="4" rx="1"></rect>
    </symbol>
    <symbol id="i-plus" viewBox="0 0 24 24">
      <line x1="12" y1="5" x2="12" y2="19"></line>
      <line x1="5" y1="12" x2="19" y2="12"></line>
    </symbol>
    <symbol id="i-edit" viewBox="0 0 24 24">
      <path d="M12 20h9"></path>
      <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L8 18l-4 1 1-4z"></path>
    </symbol>
    <symbol id="i-trash" viewBox="0 0 24 24">
      <polyline points="3 6 5 6 21 6"></polyline>
      <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
      <path d="M10 11v6"></path>
      <path d="M14 11v6"></path>
      <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
    </symbol>
    <symbol id="i-bag" viewBox="0 0 24 24">
      <path d="M6 8h12l1 12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2z"></path>
      <path d="M9 8V6a3 3 0 0 1 6 0v2"></path>
    </symbol>
    <symbol id="i-coin" viewBox="0 0 24 24">
      <ellipse cx="12" cy="8" rx="7" ry="3"></ellipse>
      <path d="M5 8v4c0 1.7 3.1 3 7 3s7-1.3 7-3V8"></path>
      <path d="M5 12v4c0 1.7 3.1 3 7 3s7-1.3 7-3v-4"></path>
    </symbol>
    <symbol id="i-check" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M8 12l3 3 5-6"></path>
    </symbol>
    <symbol id="i-clipboard" viewBox="0 0 24 24">
      <rect x="6" y="4" width="12" height="16" rx="2"></rect>
      <path d="M9 4V3h6v1"></path>
      <line x1="9" y1="9" x2="15" y2="9"></line>
      <line x1="9" y1="13" x2="15" y2="13"></line>
    </symbol>
    <symbol id="i-box" viewBox="0 0 24 24">
      <path d="M21 16V8a2 2 0 0 0-1-1.7l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.7l7 4a2 2 0 0 0 2 0l7-4a2 2 0 0 0 1-1.7z"></path>
      <line x1="3" y1="8" x2="21" y2="8"></line>
      <line x1="12" y1="12" x2="12" y2="22"></line>
    </symbol>
  </svg>
  <div class="app">
    <header>
      <div class="header-top">
        <h1><svg class="icon title-icon"><use href="#i-cart"></use></svg> Shopping Tracker</h1>
        <div class="header-actions">
          <button class="btn btn-secondary" onclick="showGlobalSearchModal()">
             <svg class="icon"><use href="#i-search"></use></svg> Search
          </button>
          <div class="dropdown">
            <button class="btn btn-secondary" onclick="toggleDropdown('export-dropdown')">
              <svg class="icon"><use href="#i-upload"></use></svg> Export
            </button>
            <div id="export-dropdown" class="dropdown-content">
              <div class="dropdown-item" onclick="exportAll()">Export All Data (JSON)</div>
              <div class="dropdown-item" onclick="exportAllToExcel()">Export All Data (Excel)</div>
              <div class="dropdown-item" onclick="showExportModal()">Export Selected...</div>
            </div>
          </div>
          <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">
            <svg class="icon"><use href="#i-download"></use></svg> Import
          </button>
          <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
        </div>
      </div>
    </header>

    <nav>
      <button class="nav-btn active" data-view="lists" onclick="switchView('lists')"><svg class="icon"><use href="#i-list"></use></svg> Lists</button>
      <button class="nav-btn" data-view="groups" onclick="switchView('groups')"><svg class="icon"><use href="#i-folder"></use></svg> Groups</button>
      <button class="nav-btn" data-view="analytics" onclick="switchView('analytics')"><svg class="icon icon-analytics"><use href="#i-chart"></use></svg> Analytics</button>
    </nav>

    <main id="main-content"></main>
  </div>

  <script>
    // State Management
    let state = {
      lists: [],
      groups: [],
      currentView: 'lists',
      currentList: null,
      selectedListsForAnalytics: [],
      viewingGroupId: null // For Groups Drill-down
    };

    const DEFAULT_GROUP_COLOR = '#0f766e';

    let uiState = {
      collapsedGroups: {} // Format: { "groupId": true/false, "ungrouped": true/false }
    };

    // Initialize
    function init() {
      loadState();
      loadUIState();
      render();
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown')) {
          document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
        }
      });
    }

    // Storage
    function loadState() {
      const saved = localStorage.getItem('shoppingTracker');
      if (saved) {
        const parsed = JSON.parse(saved);
        state.lists = parsed.lists || [];
        state.groups = parsed.groups || [];
      }
    }

    function saveState() {
      localStorage.setItem('shoppingTracker', JSON.stringify({
        lists: state.lists,
        groups: state.groups
      }));
    }

    function loadUIState() {
      const savedUI = localStorage.getItem('shoppingTrackerUI');
      if (savedUI) {
        uiState = JSON.parse(savedUI);
      }
      if (!uiState.collapsedGroups) uiState.collapsedGroups = {};
    }

    function saveUIState() {
      localStorage.setItem('shoppingTrackerUI', JSON.stringify(uiState));
    }

    function toggleGroupCollapse(groupId) {
      uiState.collapsedGroups[groupId] = !uiState.collapsedGroups[groupId];
      saveUIState();
      render();
    }

    // Utility Functions
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      return new Date(dateStr).toLocaleDateString('en-US', {
        month: 'short', day: 'numeric', year: 'numeric'
      });
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '';
      return new Date(dateStr).toLocaleString('en-US', {
        month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
      });
    }

    function formatIsoDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      if (Number.isNaN(date.getTime())) return '';
      return date.toISOString().slice(0, 10);
    }

    function formatCurrency(amount) {
      return '$' + (amount || 0).toFixed(2);
    }

    function icon(name, cls = '') {
      return `<svg class="icon ${cls}"><use href="#i-${name}"></use></svg>`;
    }

    function normalizeHexColor(color) {
      if (!color) return DEFAULT_GROUP_COLOR;
      const trimmed = color.trim();
      const hex = trimmed.startsWith('#') ? trimmed : `#${trimmed}`;
      if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(hex)) {
        return hex;
      }
      return DEFAULT_GROUP_COLOR;
    }

    function hexToRgba(hex, alpha) {
      let cleaned = normalizeHexColor(hex).replace('#', '');
      if (cleaned.length === 3) {
        cleaned = cleaned.split('').map((c) => c + c).join('');
      }
      const r = parseInt(cleaned.slice(0, 2), 16);
      const g = parseInt(cleaned.slice(2, 4), 16);
      const b = parseInt(cleaned.slice(4, 6), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function getGroupTagStyle(group) {
      const color = normalizeHexColor(group?.color);
      const bg = hexToRgba(color, 0.16);
      const border = hexToRgba(color, 0.32);
      return `style="background: ${bg}; color: ${color}; border-color: ${border};"`;
    }

    function toggleDropdown(id) {
      event.stopPropagation();
      const dropdown = document.getElementById(id);
      document.querySelectorAll('.dropdown-content').forEach(d => {
        if (d.id !== id) d.classList.remove('show');
      });
      dropdown.classList.toggle('show');
    }

    function togglePriceRequired() {
      // Placeholder
    }

    function previewImage(event) {
      const file = event.target.files[0];
      const preview = document.getElementById('image-preview');
      if (file && preview) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; max-height: 150px; border-radius: 8px;">`;
        }
        reader.readAsDataURL(file);
      }
    }

    function updatePriceInputState() {
      const modeEl = document.querySelector('input[name="price-mode"]:checked');
      if(!modeEl) return;
      const mode = modeEl.value;
      const priceInput = document.getElementById('item-price');
      const qtyInput = document.getElementById('item-quantity');
      const label = document.getElementById('price-input-label');
      const preview = document.getElementById('price-total-preview');
      
      const val = parseFloat(priceInput.value) || 0;
      const qty = parseInt(qtyInput.value) || 1;
      
      label.textContent = mode === 'unit' ? 'Price per Unit' : 'Total Price';
      
      let total = 0;
      if (mode === 'unit') {
        total = val * qty;
      } else {
        total = val;
      }
      
      preview.textContent = `Total: ${formatCurrency(total)}`;
      preview.style.color = mode === 'unit' ? 'var(--text-light)' : 'var(--primary)';
    }

    function togglePriceMode(newMode) {
      const priceInput = document.getElementById('item-price');
      const qtyInput = document.getElementById('item-quantity');
      const currentVal = parseFloat(priceInput.value);
      const qty = parseInt(qtyInput.value) || 1;

      if (!isNaN(currentVal)) {
        if (newMode === 'unit') {
          priceInput.value = (currentVal / qty).toFixed(2);
        } else {
          priceInput.value = (currentVal * qty).toFixed(2);
        }
      }
      updatePriceInputState();
    }
    
    // View Management
    function switchView(view) {
      state.currentView = view;
      state.currentList = null;
      state.viewingGroupId = null; // Reset group drill-down
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      render();
    }

    function render() {
      const main = document.getElementById('main-content');
      switch (state.currentView) {
        case 'lists':
          main.innerHTML = state.currentList ? renderListDetail() : renderLists();
          break;
        case 'groups':
          main.innerHTML = state.viewingGroupId ? renderGroupDetail(state.viewingGroupId) : renderGroups();
          break;
        case 'analytics':
          main.innerHTML = renderAnalytics();
          setTimeout(renderCharts, 100);
          break;
      }
    }

    // Lists View
    function renderLists() {
      const validGroupIds = new Set(state.groups.map(g => g.id));
      const ungrouped = state.lists.filter(l => !l.groupId || !validGroupIds.has(l.groupId));
      const grouped = {};

      state.lists.filter(l => l.groupId && validGroupIds.has(l.groupId)).forEach(list => {
        if (!grouped[list.groupId]) grouped[list.groupId] = [];
        grouped[list.groupId].push(list);
      });

      let html = `
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Shopping Lists</h2>
            <button class="btn btn-primary" onclick="showNewListModal()">${icon('plus')} New List</button>
          </div>
      `;

      if (state.lists.length === 0) {
        html += `
          <div class="empty-state">
            <div class="empty-state-icon">${icon('list')}</div>
            <p>No shopping lists yet. Create one to get started!</p>
          </div>
        `;
      } else {
        // Render Grouped Lists
        Object.entries(grouped).forEach(([groupId, lists]) => {
          const group = state.groups.find(g => g.id === groupId);
          if (group) {
            const isCollapsed = uiState.collapsedGroups[groupId];
            html += `
              <div class="group-section">
                <div class="group-header" onclick="toggleGroupCollapse('${groupId}')">
                  <div class="group-title-wrapper">
                    <span class="chevron ${isCollapsed ? 'rotated' : ''}">▼</span>
                    <span class="group-title">${icon('folder', 'icon-muted')} ${group.name}</span>
                    <span style="font-size: 0.8rem; color: var(--text-light);">(${lists.length})</span>
                  </div>
                </div>
                ${!isCollapsed ? `<div class="grid">${lists.map(renderListCard).join('')}</div>` : ''}
              </div>
            `;
          }
        });

        // Render Ungrouped Lists
        if (ungrouped.length > 0) {
          const isCollapsed = uiState.collapsedGroups['ungrouped'];
          html += `
            <div class="group-section">
              <div class="group-header" onclick="toggleGroupCollapse('ungrouped')">
                 <div class="group-title-wrapper">
                    <span class="chevron ${isCollapsed ? 'rotated' : ''}">▼</span>
                    <span class="group-title">Ungrouped</span>
                    <span style="font-size: 0.8rem; color: var(--text-light);">(${ungrouped.length})</span>
                 </div>
              </div>
              ${!isCollapsed ? `<div class="grid">${ungrouped.map(renderListCard).join('')}</div>` : ''}
            </div>
          `;
        }
      }

      html += '</div>';
      return html;
    }

    function renderListCard(list) {
      const totalSpent = list.items.filter(i => i.purchased).reduce((sum, i) => sum + i.price, 0);
      const totalItems = list.items.length;
      const purchasedItems = list.items.filter(i => i.purchased).length;
      const budgetPercent = list.budget ? (totalSpent / list.budget) * 100 : 0;
      const budgetClass = budgetPercent > 100 ? 'budget-over' : budgetPercent > 80 ? 'budget-warning' : 'budget-under';
      const group = state.groups.find(g => g.id === list.groupId);
      const groupName = group?.name;
      const groupTagStyle = groupName ? getGroupTagStyle(group) : '';

      return `
        <div class="list-card" onclick="openList('${list.id}')">
          <div class="list-card-header">
            <div class="list-card-header-info">
              <div class="list-card-title">${list.name}</div>
              <div class="list-card-date">${formatDate(list.createdAt)}</div>
            </div>
            ${groupName ? `<span class="tag tag-group" ${groupTagStyle}>${groupName}</span>` : ''}
          </div>
          <div class="list-card-stats">
            <span class="stat">${icon('bag', 'icon-muted')} ${purchasedItems}/${totalItems} items</span>
            <span class="stat">${icon('coin', 'icon-muted')} ${formatCurrency(totalSpent)}</span>
          </div>
          ${list.budget ? `
            <div class="budget-bar">
              <div class="budget-bar-fill ${budgetClass}" style="width: ${Math.min(budgetPercent, 100)}%"></div>
            </div>
            <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 4px;">
              Budget: ${formatCurrency(list.budget)}
              ${
                budgetPercent >= 100
                  ? `<span style="color: var(--danger)"> (${(budgetPercent - 100).toFixed(0)}% over)</span>`
                  : `<span style="color: var(--success)"> (${(100 - budgetPercent).toFixed(0)}% under)</span>`
              }
            </div>
          ` : ''}
        </div>
      `;
    }

    function openList(id) {
      state.currentList = state.lists.find(l => l.id === id);
      
      // If we are coming from another view (like Groups or Search), switch to Lists view context
      if (state.currentView !== 'lists') {
          state.currentView = 'lists';
          state.viewingGroupId = null; // Clear group drill-down state
          
          // Update Nav UI
          document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === 'lists');
          });
      }
      
      render();
    }

    function openListFromDetail(id) {
        state.currentView = 'lists';
        state.currentList = state.lists.find(l => l.id === id);
        render();
    }

    // List Detail View
    function renderListDetail() {
      const list = state.currentList;
      const totalSpent = list.items.filter(i => i.purchased).reduce((sum, i) => sum + i.price, 0);
      const todoItems = list.items.filter(i => !i.purchased);
      const purchasedItems = list.items.filter(i => i.purchased);

      return `
        <div class="back-btn" onclick="state.currentList = null; render();">
          ← Back to Lists
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="card-title">${list.name}</h2>
              <div style="color: var(--text-light); font-size: 0.875rem;">
                Created ${formatDate(list.createdAt)}
                ${list.groupId ? `• ${icon('folder', 'icon-muted')} ${state.groups.find(g => g.id === list.groupId)?.name || 'Ungrouped'}` : ''}
              </div>
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn btn-primary btn-sm" onclick="showAddItemModal()">${icon('plus')} Add Item</button>
              <button class="btn btn-secondary btn-sm" onclick="showEditListModal()">${icon('edit')} Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deleteList('${list.id}')" title="Delete list">${icon('trash')}</button>
            </div>
          </div>

          <div class="summary-grid">
            <div class="summary-card">
              <div class="summary-value">${formatCurrency(totalSpent)}</div>
              <div class="summary-label">Total Spent</div>
            </div>
            <div class="summary-card">
              <div class="summary-value">${purchasedItems.length}/${list.items.length}</div>
              <div class="summary-label">Items Purchased</div>
            </div>
            ${list.budget ? `
              <div class="summary-card">
                <div class="summary-value" style="color: ${totalSpent > list.budget ? 'var(--danger)' : 'var(--success)'}">
                  ${formatCurrency(list.budget - totalSpent)}
                </div>
                <div class="summary-label">${totalSpent > list.budget ? 'Over Budget' : 'Remaining'}</div>
              </div>
            ` : ''}
          </div>

          ${todoItems.length > 0 ? `
            <h3 style="margin: 24px 0 12px; color: var(--warning);">${icon('list', 'icon-sm')} To Buy (${todoItems.length})</h3>
            <div class="item-list">
              ${todoItems.map(item => renderItem(item, list.id)).join('')}
            </div>
          ` : ''}

          ${purchasedItems.length > 0 ? `
            <h3 style="margin: 24px 0 12px; color: var(--success);">${icon('check', 'icon-sm')} Purchased (${purchasedItems.length})</h3>
            <div class="item-list">
              ${purchasedItems.map(item => renderItem(item, list.id)).join('')}
            </div>
          ` : ''}

          ${list.items.length === 0 ? `
            <div class="empty-state">
              <div class="empty-state-icon">${icon('cart')}</div>
              <p>No items yet. Add items to your shopping list!</p>
            </div>
          ` : ''}
        </div>
      `;
    }

    function renderItem(item, listId) {
      let priceDisplay = formatCurrency(item.price);
      let unitDetail = '';
      
      if (item.priceMode === 'unit' && item.quantity > 1) {
        unitDetail = `<div style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 2px;">
          ${formatCurrency(item.unitPrice)} ea
        </div>`;
      } else if (item.priceMode === 'total' && item.quantity > 1) {
         unitDetail = `<div style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 2px;">
          Bulk / Total
        </div>`;
      }

      return `
        <div id="item-${item.id}" class="item-card ${item.purchased ? 'purchased' : 'todo'}">
          <input type="checkbox" class="item-checkbox" 
            ${item.purchased ? 'checked' : ''} 
            onchange="toggleItemPurchased('${listId}', '${item.id}', this.checked)">
          ${item.image ? `<img src="${item.image}" class="item-image" alt="${item.name}">` : 
            `<div class="item-image-placeholder">${icon('box')}</div>`}
          <div class="item-details">
            <div class="item-name">${item.name}</div>
            <div class="item-meta">
              Qty: ${item.quantity}
              ${item.notes ? `• ${item.notes}` : ''}
            </div>
          </div>
          <div style="text-align: right;">
            ${unitDetail}
            <div class="item-price">${priceDisplay}</div>
          </div>
          <div class="item-actions" style="margin-left: 12px;">
            <button class="btn btn-secondary btn-sm" onclick="showEditItemModal('${item.id}')" title="Edit item">${icon('edit')}</button>
            <button class="btn btn-danger btn-sm" onclick="deleteItem('${listId}', '${item.id}')" title="Delete item">${icon('trash')}</button>
          </div>
        </div>
      `;
    }

    function toggleItemPurchased(listId, itemId, purchased) {
      const list = state.lists.find(l => l.id === listId);
      const item = list.items.find(i => i.id === itemId);
      
      if (purchased && !item.purchased) {
        showCheckOffModal(item);
      } else {
        item.purchased = purchased;
        if (!purchased) {
          item.purchasedAt = null;
        }
        saveState();
        render();
      }
    }

    // Groups Overview
    function renderGroups() {
      // Calculate ungrouped stats
      const validGroupIds = new Set(state.groups.map(g => g.id));
      const ungroupedLists = state.lists.filter(l => !l.groupId || !validGroupIds.has(l.groupId));
      const ungroupedSpent = ungroupedLists.reduce((sum, l) => 
          sum + l.items.filter(i => i.purchased).reduce((s, i) => s + i.price, 0), 0);

      return `
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">List Groups</h2>
            <button class="btn btn-primary" onclick="showNewGroupModal()">${icon('plus')} New Group</button>
          </div>

          ${state.groups.length === 0 && ungroupedLists.length === 0 ? `
            <div class="empty-state">
              <div class="empty-state-icon">${icon('folder')}</div>
              <p>No groups yet. Create groups to organize your lists!</p>
            </div>
          ` : `
            <div class="grid">
              ${state.groups.map(group => {
                const listsInGroup = state.lists.filter(l => l.groupId === group.id);
                const totalSpent = listsInGroup.reduce((sum, l) => 
                  sum + l.items.filter(i => i.purchased).reduce((s, i) => s + i.price, 0), 0);
                return `
                  <div class="list-card clickable-group-card" onclick="openGroupDetail('${group.id}')">
                    <div class="list-card-header">
                      <div class="list-card-title">${icon('folder', 'icon-muted')} ${group.name}</div>
                      <div style="display: flex; gap: 4px;">
                        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); showEditGroupModal('${group.id}')">${icon('edit')} Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteGroup('${group.id}')" title="Delete group">${icon('trash')}</button>
                      </div>
                    </div>
                    <div class="list-card-stats">
                      <span class="stat">${icon('list', 'icon-muted')} ${listsInGroup.length} lists</span>
                      <span class="stat">${icon('coin', 'icon-muted')} ${formatCurrency(totalSpent)} spent</span>
                    </div>
                  </div>
                `;
              }).join('')}

              ${ungroupedLists.length > 0 ? `
                  <div class="list-card clickable-group-card" onclick="openGroupDetail('ungrouped')">
                    <div class="list-card-header">
                      <div class="list-card-title">Ungrouped Lists</div>
                    </div>
                    <div class="list-card-stats">
                      <span class="stat">${icon('list', 'icon-muted')} ${ungroupedLists.length} lists</span>
                      <span class="stat">${icon('coin', 'icon-muted')} ${formatCurrency(ungroupedSpent)} spent</span>
                    </div>
                  </div>
              ` : ''}
            </div>
          `}
        </div>
      `;
    }

    function openGroupDetail(groupId) {
        state.viewingGroupId = groupId;
        render();
    }

    // Group Detail View (Drill-down)
    function renderGroupDetail(groupId) {
        let groupName = 'Ungrouped';
        let lists = [];

        if (groupId === 'ungrouped') {
            const validGroupIds = new Set(state.groups.map(g => g.id));
            lists = state.lists.filter(l => !l.groupId || !validGroupIds.has(l.groupId));
        } else {
            const group = state.groups.find(g => g.id === groupId);
            if (!group) {
                // Handle case where group deleted while viewing
                state.viewingGroupId = null;
                return renderGroups();
            }
            groupName = group.name;
            lists = state.lists.filter(l => l.groupId === groupId);
        }

        return `
            <div class="back-btn" onclick="state.viewingGroupId = null; render();">
              ← Back to Groups
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">${groupId === 'ungrouped' ? '' : icon('folder', 'icon-muted')} ${groupName}</h2>
                        <div style="color: var(--text-light); font-size: 0.875rem;">
                            ${lists.length} lists
                        </div>
                    </div>
                    ${groupId !== 'ungrouped' ? `
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary btn-sm" onclick="showEditGroupModal('${groupId}')">${icon('edit')} Edit Group</button>
                    </div>
                    ` : ''}
                </div>

                ${lists.length === 0 ? `
                    <div class="empty-state">
                        <p>No lists in this group.</p>
                    </div>
                ` : `
                    <div class="grid">
                        ${lists.map(renderListCard).join('')}
                    </div>
                `}
            </div>
        `;
    }

    // Analytics View
    function renderAnalytics() {
      return `
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Spending Analytics</h2>
          </div>

          <div class="form-group">
            <label class="form-label">Select Lists to Analyze</label>
            <div class="checkbox-list">
              ${state.lists.map(list => `
                <label class="checkbox-item">
                  <input type="checkbox" 
                    ${state.selectedListsForAnalytics.includes(list.id) ? 'checked' : ''}
                    onchange="toggleAnalyticsList('${list.id}')">
                  <span>${list.name} (${formatDate(list.createdAt)})</span>
                </label>
              `).join('')}
            </div>
            <div style="margin-top: 8px;">
              <button class="btn btn-secondary btn-sm" onclick="selectAllForAnalytics()">Select All</button>
              <button class="btn btn-secondary btn-sm" onclick="clearAnalyticsSelection()">Clear</button>
            </div>
          </div>

          ${renderAnalyticsSummary()}
          
          <div class="chart-container">
            <canvas id="spending-chart"></canvas>
          </div>

          <div class="chart-container">
            <canvas id="cost-trend-chart"></canvas>
             <div style="text-align: center; font-size: 0.8rem; color: var(--text-light); margin-top: 8px;">
               Tap chart area to see details
            </div>
          </div>

          <div class="chart-container">
            <canvas id="items-chart"></canvas>
             <div style="text-align: center; font-size: 0.8rem; color: var(--text-light); margin-top: 8px;">
               Tap chart area to see details
            </div>
          </div>
        </div>
      `;
    }

    function renderAnalyticsSummary() {
      const selectedLists = state.lists.filter(l => state.selectedListsForAnalytics.includes(l.id));
      
      if (selectedLists.length === 0) {
        return `
          <div class="empty-state">
            <p>Select lists above to see spending analytics</p>
          </div>
        `;
      }

      const totalSpent = selectedLists.reduce((sum, l) => 
        sum + l.items.filter(i => i.purchased).reduce((s, i) => s + i.price, 0), 0);
      const totalItems = selectedLists.reduce((sum, l) => sum + l.items.filter(i => i.purchased).length, 0);
      const avgPerList = totalSpent / selectedLists.length;
      
      return `
        <div class="summary-grid">
          <div class="summary-card">
            <div class="summary-value">${formatCurrency(totalSpent)}</div>
            <div class="summary-label">Total Spent</div>
          </div>
          <div class="summary-card">
            <div class="summary-value">${totalItems}</div>
            <div class="summary-label">Items Purchased</div>
          </div>
          <div class="summary-card">
            <div class="summary-value">${formatCurrency(avgPerList)}</div>
            <div class="summary-label">Avg per List</div>
          </div>
          <div class="summary-card">
            <div class="summary-value">${selectedLists.length}</div>
            <div class="summary-label">Lists Analyzed</div>
          </div>
        </div>
      `;
    }

    function toggleAnalyticsList(id) {
      const idx = state.selectedListsForAnalytics.indexOf(id);
      if (idx > -1) {
        state.selectedListsForAnalytics.splice(idx, 1);
      } else {
        state.selectedListsForAnalytics.push(id);
      }
      render();
    }

    function selectAllForAnalytics() {
      state.selectedListsForAnalytics = state.lists.map(l => l.id);
      render();
    }

    function clearAnalyticsSelection() {
      state.selectedListsForAnalytics = [];
      render();
    }

    function renderCharts() {
      const selectedLists = state.lists
        .filter(l => state.selectedListsForAnalytics.includes(l.id))
        .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

      if (selectedLists.length === 0) return;

      const labels = selectedLists.map(l => formatDate(l.createdAt));
      const spendingData = selectedLists.map(l => 
         l.items.filter(i => i.purchased).reduce((s, i) => s + i.price, 0));
      const budgetData = selectedLists.map(l => l.budget || 0);
      const itemsData = selectedLists.map(l => l.items.filter(i => i.purchased).length);

      const handleChartClick = (e, elements, chart) => {
          let index = -1;
          if (elements && elements.length > 0) {
              index = elements[0].index;
          } else {
              const canvasPosition = Chart.helpers.getRelativePosition(e, chart);
              const dataX = chart.scales.x.getValueForPixel(canvasPosition.x);
              if (dataX >= 0 && dataX < selectedLists.length) {
                  index = dataX;
              }
          }
          if (index !== -1) {
              const list = selectedLists[index];
              if(list) showListSummaryModal(list);
          }
      };

      const barColors = spendingData.map((spent, index) => {
        const budget = budgetData[index];
        if (budget > 0 && spent > budget) {
          return '#ef4444';
        }
        return '#4f46e5';
      });

      const splitCanvas = document.createElement('canvas');
      splitCanvas.width = 40;
      splitCanvas.height = 12;
      const sCtx = splitCanvas.getContext('2d');
      sCtx.fillStyle = '#ef4444';
      sCtx.fillRect(0, 0, 20, 12);
      sCtx.fillStyle = '#4f46e5';
      sCtx.fillRect(20, 0, 20, 12);
      const splitImage = new Image();
      splitImage.src = splitCanvas.toDataURL();

      const spendingCtx = document.getElementById('spending-chart');
      if (spendingCtx) {
        const existingChart = Chart.getChart(spendingCtx);
        if (existingChart) existingChart.destroy();

        new Chart(spendingCtx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label: 'Spent',
                data: spendingData,
                backgroundColor: barColors,
                borderRadius: 4
              },
              {
                label: 'Budget',
                data: budgetData,
                backgroundColor: '#e5e7eb',
                borderRadius: 4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: { display: true, text: 'Spending vs Budget Over Time' },
              legend: {
                labels: {
                  usePointStyle: true,
                  pointStyleWidth: 40,
                  generateLabels: function(chart) {
                    const original = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                    return original.map(label => {
                      if (label.text === 'Spent') {
                        label.pointStyle = splitImage;
                        label.fillStyle = 'transparent';
                        label.strokeStyle = 'transparent';
                      } else {
                        label.pointStyle = 'rectRounded';
                      }
                      return label;
                    });
                  }
                }
              },
              tooltip: {
                callbacks: {
                  afterLabel: function(context) {
                    const idx = context.dataIndex;
                    if (context.dataset.label === 'Spent') {
                      const budget = budgetData[idx];
                      const spent = spendingData[idx];
                      if (budget > 0 && spent > budget) {
                        return `Over Budget by ${formatCurrency(spent - budget)}!`;
                      }
                    }
                  }
                }
              }
            },
            scales: {
              y: { beginAtZero: true, ticks: { callback: value => '$' + value } }
            }
          }
        });
      }

      const costTrendCtx = document.getElementById('cost-trend-chart');
      if (costTrendCtx) {
        const existingChart = Chart.getChart(costTrendCtx);
        if (existingChart) existingChart.destroy();

        new Chart(costTrendCtx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Total Cost per Trip',
              data: spendingData,
              borderColor: '#f59e0b',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              fill: true,
              tension: 0.3,
              pointBackgroundColor: '#f59e0b',
              pointRadius: 6,
              pointHitRadius: 50
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            onClick: handleChartClick,
            plugins: {
                title: { display: true, text: 'Total Cost / List Over Time' },
                tooltip: { enabled: false }
            },
            scales: { y: { beginAtZero: true, ticks: { callback: value => '$' + value } } }
          }
        });
      }

      const itemsCtx = document.getElementById('items-chart');
      if (itemsCtx) {
        const existingChart = Chart.getChart(itemsCtx);
        if (existingChart) existingChart.destroy();

        new Chart(itemsCtx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Items Purchased',
              data: itemsData,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 6,
              pointHitRadius: 50
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            onClick: handleChartClick,
            plugins: {
              title: { display: true, text: 'Items Purchased Over Time' },
              tooltip: { enabled: false }
            },
            scales: { y: { beginAtZero: true } }
          }
        });
      }
    }

    function showListSummaryModal(list) {
      const totalSpent = list.items.filter(i => i.purchased).reduce((sum, i) => sum + i.price, 0);
      const itemsCount = list.items.filter(i => i.purchased).length;
      
      showModal(`
        <div class="modal-header">
          <h3 class="modal-title">${list.name}</h3>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div style="text-align: center; margin-bottom: 20px;">
           <div style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 4px;">${formatDate(list.createdAt)}</div>
           <div class="summary-value">${formatCurrency(totalSpent)}</div>
           <div style="font-size: 0.9rem; color: var(--text-light); margin-top: 4px;">
             ${itemsCount} Items Purchased
           </div>
           ${list.budget ? `
             <div style="margin-top: 8px; font-weight: 500; color: ${totalSpent > list.budget ? 'var(--danger)' : 'var(--success)'}">
               ${totalSpent > list.budget ? 'Over Budget' : 'Under Budget'} (${formatCurrency(list.budget)})
             </div>
           ` : ''}
        </div>
        <div class="form-actions" style="justify-content: center;">
          <button class="btn btn-secondary" onclick="closeModal()">Close</button>
          <button class="btn btn-primary" onclick="closeModal(); openListFromDetail('${list.id}');">View Full List</button>
        </div>
      `);
    }

    function showEditGroupModal(groupId, preservedName = null, preservedColor = null) {
      const group = state.groups.find(g => g.id === groupId);
      const inGroup = state.lists.filter(l => l.groupId === groupId);
      const available = state.lists.filter(l => !l.groupId);
      const nameValue = preservedName !== null ? preservedName : group.name;
      const colorValue = preservedColor !== null ? preservedColor : (group.color || DEFAULT_GROUP_COLOR);

      showModal(`
        <div class="modal-header">
          <h3 class="modal-title">Edit Group</h3>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <form onsubmit="updateGroup(event, '${groupId}')">
          <div class="form-group">
            <label class="form-label">Group Name *</label>
            <input type="text" class="form-input" id="group-name" required value="${nameValue}">
          </div>
          <div class="form-group">
            <label class="form-label">Group Color</label>
            <input type="color" class="form-input" id="group-color" value="${colorValue}">
          </div>
          
          <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">
          
          <div style="max-height: 50vh; overflow-y: auto;">
            
            <div class="manage-section">
              <div class="manage-section-header">
                <div class="manage-section-title">In this Group (${inGroup.length})</div>
                <button type="button" class="select-toggle" onclick="toggleSelectAll('in-group-cb')">Select All</button>
              </div>
              
              ${inGroup.length === 0 
                ? `<div style="color: var(--text-light); font-style: italic; font-size: 0.9rem;">No lists in this group</div>` 
                : inGroup.map(list => `
                  <label class="manage-list-item">
                    <input type="checkbox" class="manage-checkbox in-group-cb" value="${list.id}">
                    <div>
                      <div style="font-weight: 500;">${list.name}</div>
                      <div style="font-size: 0.75rem; color: var(--text-light);">${formatDate(list.createdAt)}</div>
                    </div>
                  </label>
                `).join('')}

              ${inGroup.length > 0 ? `
                <div class="bulk-actions-bar">
                    <button type="button" class="btn btn-danger btn-sm btn-block" onclick="bulkRemoveLists('${groupId}')">Remove Selected</button>
                </div>
              ` : ''}
            </div>

            <div class="manage-section">
               <div class="manage-section-header">
                <div class="manage-section-title">Available Lists (${available.length})</div>
                <button type="button" class="select-toggle" onclick="toggleSelectAll('available-cb')">Select All</button>
              </div>

              ${available.length === 0 
                ? `<div style="color: var(--text-light); font-style: italic; font-size: 0.9rem;">No available lists</div>` 
                : available.map(list => `
                  <label class="manage-list-item">
                    <input type="checkbox" class="manage-checkbox available-cb" value="${list.id}">
                    <div>
                      <div style="font-weight: 500;">${list.name}</div>
                      <div style="font-size: 0.75rem; color: var(--text-light);">${formatDate(list.createdAt)}</div>
                    </div>
                  </label>
                `).join('')}

              ${available.length > 0 ? `
                 <div class="bulk-actions-bar">
                    <button type="button" class="btn btn-success btn-sm btn-block" onclick="bulkAddLists('${groupId}')">Add Selected</button>
                </div>
              ` : ''}
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Close / Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      `);
    }

    function toggleSelectAll(className) {
        const checkboxes = document.querySelectorAll(`.${className}`);
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
    }

    function bulkRemoveLists(groupId) {
        const checkboxes = document.querySelectorAll('.in-group-cb:checked');
        if (checkboxes.length === 0) return;

        const listIds = Array.from(checkboxes).map(cb => cb.value);
        state.lists.forEach(list => {
            if (listIds.includes(list.id)) {
                list.groupId = null;
            }
        });
        saveState();
        reloadModalWithState(groupId);
    }

    function bulkAddLists(groupId) {
        const checkboxes = document.querySelectorAll('.available-cb:checked');
        if (checkboxes.length === 0) return;

        const listIds = Array.from(checkboxes).map(cb => cb.value);
        state.lists.forEach(list => {
            if (listIds.includes(list.id)) {
                list.groupId = groupId;
            }
        });
        saveState();
        reloadModalWithState(groupId);
    }

    function reloadModalWithState(groupId) {
        const currentNameInput = document.getElementById('group-name');
        const currentColorInput = document.getElementById('group-color');
        const preservedName = currentNameInput ? currentNameInput.value : null;
        const preservedColor = currentColorInput ? currentColorInput.value : null;
        showEditGroupModal(groupId, preservedName, preservedColor);
        render();
    }

    function showGlobalSearchModal() {
        showModal(`
            <div class="modal-header">
                <h3 class="modal-title">Search Everything</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="form-group">
                <input type="text" id="globalSearchInput" class="form-input" 
                       placeholder="Type to search items..." 
                       onkeyup="debounceSearch()" autofocus>
            </div>
            <div class="form-group" style="display: flex; gap: 8px;">
                <label style="cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <input type="checkbox" id="globalSearchPurchasedOnly" onchange="runGlobalSearch()">
                    <span style="font-size: 0.9rem;">Purchased only</span>
                </label>
            </div>
            <div id="globalSearchResults" style="max-height: 50vh; overflow-y: auto;">
                <div style="color: var(--text-light); text-align: center; padding: 20px;">
                    Start typing to search...
                </div>
            </div>
        `);
        setTimeout(() => document.getElementById('globalSearchInput').focus(), 50);
    }

    let searchTimeout;
    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(runGlobalSearch, 200);
    }

    function runGlobalSearch() {
        const query = document.getElementById('globalSearchInput').value.toLowerCase().trim();
        const purchasedOnly = document.getElementById('globalSearchPurchasedOnly').checked;
        const resultsContainer = document.getElementById('globalSearchResults');

        if (!query) {
            resultsContainer.innerHTML = '<div style="color: var(--text-light); text-align: center; padding: 20px;">Start typing to search...</div>';
            return;
        }

        let results = [];
        state.lists.forEach(list => {
            const groupName = state.groups.find(g => g.id === list.groupId)?.name || 'Ungrouped';
            list.items.forEach(item => {
                if (purchasedOnly && !item.purchased) return;
                if (item.name.toLowerCase().includes(query)) {
                    results.push({
                        item: item,
                        list: list,
                        groupName: groupName
                    });
                }
            });
        });

        results.sort((a, b) => {
            if (a.item.purchased && !b.item.purchased) return -1;
            if (!a.item.purchased && b.item.purchased) return 1;
            const dateA = new Date(a.item.purchased ? a.item.purchasedAt : a.item.createdAt);
            const dateB = new Date(b.item.purchased ? b.item.purchasedAt : b.item.createdAt);
            return dateB - dateA;
        });

        if (results.length === 0) {
            resultsContainer.innerHTML = '<div style="text-align: center; padding: 20px;">No results found.</div>';
            return;
        }

        resultsContainer.innerHTML = results.map(r => `
            <div class="search-result-item" onclick="navigateToItem('${r.list.id}', '${r.item.id}')">
                <div style="font-weight: 600;">${r.item.name}</div>
                <div class="search-result-meta">
                    <span>${r.groupName} > ${r.list.name}</span>
                    <span>${r.item.purchased ? `${icon('check', 'icon-sm')} ${formatDateTime(r.item.purchasedAt)}` : 'Todo'}</span>
                </div>
            </div>
        `).join('');
    }

    function navigateToItem(listId, itemId) {
        closeModal();
        switchView('lists');
        openList(listId);
        setTimeout(() => {
            const el = document.getElementById('item-' + itemId);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.classList.add('search-highlight');
                setTimeout(() => el.classList.remove('search-highlight'), 2000);
            }
        }, 150);
    }

    function showModal(content) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'modal';
      modal.innerHTML = `<div class="modal">${content}</div>`;
      modal.onclick = (e) => {
        if (e.target === modal) closeModal();
      };
      document.body.appendChild(modal);
    }

    function closeModal() {
      const modal = document.getElementById('modal');
      if (modal) modal.remove();
    }

    // List Modals
    function showNewListModal() {
      showModal(`
        <div class="modal-header">
          <h3 class="modal-title">Create New List</h3>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <form onsubmit="createList(event)">
          <div class="form-group">
            <label class="form-label">List Name *</label>
            <input type="text" class="form-input" id="list-name" required placeholder="e.g., Weekly Groceries">
          </div>
          <div class="form-group">
            <label class="form-label">Budget (optional)</label>
            <input type="number" class="form-input" id="list-budget" step="0.01" min="0" placeholder="0.00">
          </div>
          <div class="form-group">
            <label class="form-label">Group (optional)</label>
            <select class="form-input" id="list-group">
              <option value="">No Group</option>
              ${state.groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('')}
            </select>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Create List</button>
          </div>
        </form>
      `);
    }

    function createList(e) {
      e.preventDefault();
      const list = {
        id: generateId(),
        name: document.getElementById('list-name').value,
        budget: parseFloat(document.getElementById('list-budget').value) || 0,
        groupId: document.getElementById('list-group').value || null,
        items: [],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      state.lists.push(list);
      saveState();
      closeModal();
      render();
    }

    function showEditListModal() {
      const list = state.currentList;
      showModal(`
        <div class="modal-header">
          <h3 class="modal-title">Edit List</h3>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <form onsubmit="updateList(event)">
          <div class="form-group">
            <label class="form-label">List Name *</label>
            <input type="text" class="form-input" id="list-name" required value="${list.name}">
          </div>
          <div class="form-group">
            <label class="form-label">Budget</label>
            <input type="number" class="form-input" id="list-budget" step="0.01" min="0" value="${list.budget || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Group</label>
            <select class="form-input" id="list-group">
              <option value="">No Group</option>
              ${state.groups.map(g => `<option value="${g.id}" ${list.groupId === g.id ? 'selected' : ''}>${g.name}</option>`).join('')}
            </select>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      `);
    }

    function updateList(e) {
      e.preventDefault();
      const list = state.lists.find(l => l.id === state.currentList.id);
      list.name = document.getElementById('list-name').value;
      list.budget = parseFloat(document.getElementById('list-budget').value) || 0;
      list.groupId = document.getElementById('list-group').value || null;
      list.updatedAt = new Date().toISOString();
      state.currentList = list;
      saveState();
      closeModal();
      render();
    }

    function deleteList(id) {
      if (confirm('Are you sure you want to delete this list?')) {
        state.lists = state.lists.filter(l => l.id !== id);
        state.currentList = null;
        saveState();
        render();
      }
    }

    // Item Modals
    function showAddItemModal() {
      showModal(`
        <div class="modal-header">
          <h3 class="modal-title">Add Item</h3>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <form onsubmit="addItem(event)">
          <div class="form-group">
            <label class="form-label">Item Name *</label>
            <input type="text" class="form-input" id="item-name" required placeholder="e.g., Milk">
          </div>
          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" id="item-purchased" onchange="togglePriceRequired()"> Already purchased
            </label>
          </div>
          
          <div class="form-group price-panel">
            <div class="section-title">
              <span>Pricing</span>
              <button type="button" class="info-dot" data-tooltip="Choose how you want to enter price. Per Unit multiplies by quantity; Total Price is the full cost. The total is what affects spending.">i</button>
            </div>
            <div class="segmented">
              <label class="segmented-option">
                <input type="radio" name="price-mode" value="unit" checked onchange="togglePriceMode('unit')"> 
                <span>Per Unit</span>
              </label>
              <label class="segmented-option">
                <input type="radio" name="price-mode" value="total" onchange="togglePriceMode('total')"> 
                <span>Total Price</span>
              </label>
            </div>
            
            <div class="field-grid">
              <div>
                <label class="form-label" id="price-input-label">Price per Unit</label>
                <input type="number" class="form-input" id="item-price" step="0.01" min="0" placeholder="0.00" oninput="updatePriceInputState()">
              </div>
              <div>
                <label class="form-label">Quantity</label>
                <input type="number" class="form-input" id="item-quantity" value="1" min="1" oninput="updatePriceInputState()">
              </div>
            </div>
            <div id="price-total-preview" class="price-preview">
              Total: $0.00
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Notes (optional)</label>
            <input type="text" class="form-input" id="item-notes" placeholder="e.g., 2% fat">
          </div>
          <div class="form-group">
            <label class="form-label">Image (optional)</label>
            <input type="file" class="form-input" id="item-image" accept="image/*" onchange="previewImage(event)">
            <div id="image-preview" style="margin-top: 8px;"></div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Item</button>
          </div>
        </form>
      `);
      updatePriceInputState();
    }

    async function addItem(e) {
      e.preventDefault();
      const imageInput = document.getElementById('item-image');
      let imageData = null;

      if (imageInput.files[0]) {
        imageData = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.readAsDataURL(imageInput.files[0]);
        });
      }

      const purchased = document.getElementById('item-purchased').checked;
      const quantity = parseInt(document.getElementById('item-quantity').value) || 1;
      const inputPrice = parseFloat(document.getElementById('item-price').value) || 0;
      const priceMode = document.querySelector('input[name="price-mode"]:checked').value;

      let finalPrice = 0;
      let unitPrice = null;

      if (priceMode === 'unit') {
        unitPrice = inputPrice;
        finalPrice = unitPrice * quantity;
      } else {
        finalPrice = inputPrice;
        unitPrice = quantity > 0 ? finalPrice / quantity : 0;
      }

      const item = {
        id: generateId(),
        name: document.getElementById('item-name').value,
        price: finalPrice,
        unitPrice: unitPrice,
        priceMode: priceMode,
        quantity: quantity,
        notes: document.getElementById('item-notes').value,
        image: imageData,
        purchased: purchased,
        purchasedAt: purchased ? new Date().toISOString() : null,
        createdAt: new Date().toISOString()
      };

      const list = state.lists.find(l => l.id === state.currentList.id);
      list.items.push(item);
      list.updatedAt = new Date().toISOString();
      state.currentList = list;
      saveState();
      closeModal();
      render();
    }

    function showEditItemModal(itemId) {
      const item = state.currentList.items.find(i => i.id === itemId);
      const mode = item.priceMode || 'total';
      const displayPrice = mode === 'unit' ? (item.unitPrice || 0) : item.price;

      showModal(`
        <div class="modal-header">
          <h3 class="modal-title">Edit Item</h3>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <form onsubmit="updateItem(event, '${itemId}')">
          <div class="modal-section">
            <label class="form-label" for="item-name">Item Name *</label>
            <input type="text" class="form-input" id="item-name" required value="${item.name}">
          </div>

          <div class="modal-section price-panel">
            <div class="section-title">
              <span>Pricing</span>
              <button type="button" class="info-dot" data-tooltip="Choose how you want to enter price. Per Unit multiplies by quantity; Total Price is the full cost. The total is what affects spending.">i</button>
            </div>

            <div class="segmented">
              <label class="segmented-option">
                <input type="radio" name="price-mode" value="unit" ${mode === 'unit' ? 'checked' : ''} onchange="togglePriceMode('unit')">
                <span>Per Unit</span>
              </label>
              <label class="segmented-option">
                <input type="radio" name="price-mode" value="total" ${mode !== 'unit' ? 'checked' : ''} onchange="togglePriceMode('total')">
                <span>Total Price</span>
              </label>
            </div>
            
            <div class="field-grid">
              <div>
                <label class="form-label" id="price-input-label">Price</label>
                <input type="number" class="form-input" id="item-price" step="0.01" min="0" value="${displayPrice}" oninput="updatePriceInputState()">
              </div>
              <div>
                <label class="form-label">Quantity</label>
                <input type="number" class="form-input" id="item-quantity" value="${item.quantity}" min="1" oninput="updatePriceInputState()">
              </div>
            </div>
            <div id="price-total-preview" class="price-preview">
              Total: ${formatCurrency(item.price)}
            </div>
          </div>

          <div class="modal-section">
            <label class="form-label">Notes</label>
            <input type="text" class="form-input" id="item-notes" value="${item.notes || ''}">
          </div>

          <div class="modal-section">
            <label class="form-label">Image</label>
            <input type="file" class="form-input" id="item-image" accept="image/*" onchange="previewImage(event)">
            <div id="image-preview" style="margin-top: 8px;">
              ${item.image ? `<img src="${item.image}" style="max-width: 100%; max-height: 150px; border-radius: 8px;">` : ''}
            </div>
            ${item.image ? `<label style="margin-top: 8px; display: block;"><input type="checkbox" id="remove-image"> Remove image</label>` : ''}
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      `);
      updatePriceInputState();
    }

    async function updateItem(e, itemId) {
      e.preventDefault();
      const list = state.lists.find(l => l.id === state.currentList.id);
      const item = list.items.find(i => i.id === itemId);
      
      item.name = document.getElementById('item-name').value;
      item.quantity = parseInt(document.getElementById('item-quantity').value) || 1;
      item.notes = document.getElementById('item-notes').value;
      
      const inputPrice = parseFloat(document.getElementById('item-price').value) || 0;
      const priceMode = document.querySelector('input[name="price-mode"]:checked').value;
      
      item.priceMode = priceMode;

      if (priceMode === 'unit') {
        item.unitPrice = inputPrice;
        item.price = inputPrice * item.quantity;
      } else {
        item.price = inputPrice;
        item.unitPrice = item.quantity > 0 ? item.price / item.quantity : 0;
      }

      const removeImage = document.getElementById('remove-image')?.checked;
      if (removeImage) {
        item.image = null;
      } else {
        const imageInput = document.getElementById('item-image');
        if (imageInput.files[0]) {
          item.image = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(imageInput.files[0]);
          });
        }
      }

      list.updatedAt = new Date().toISOString();
      state.currentList = list;
      saveState();
      closeModal();
      render();
    }

    function showCheckOffModal(item) {
      const mode = item.priceMode || 'total';
      const displayPrice = mode === 'unit' ? (item.unitPrice || 0) : item.price;

      showModal(`
        <div class="modal-header">
          <h3 class="modal-title">Check Off: ${item.name}</h3>
          <button class="close-btn" onclick="closeModal(); render();">&times;</button>
        </div>
        <form onsubmit="checkOffItem(event, '${item.id}')">
          
          <div class="form-group" style="background: var(--bg); padding: 12px; border-radius: 8px;">
             <div style="display: flex; gap: 16px; margin-bottom: 12px;">
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="radio" name="price-mode" value="unit" ${mode === 'unit' ? 'checked' : ''} onchange="togglePriceMode('unit')"> 
                <span>Per Unit</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="radio" name="price-mode" value="total" ${mode !== 'unit' ? 'checked' : ''} onchange="togglePriceMode('total')"> 
                <span>Total Price</span>
              </label>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
              <div>
                <label class="form-label" id="price-input-label">Price</label>
                <input type="number" class="form-input" id="item-price" step="0.01" min="0" value="${displayPrice}" placeholder="0.00" oninput="updatePriceInputState()">
              </div>
              <div>
                <label class="form-label">Quantity</label>
                <input type="number" class="form-input" id="item-quantity" value="${item.quantity}" min="1" oninput="updatePriceInputState()">
              </div>
            </div>
            <div id="price-total-preview" style="text-align: right; margin-top: 8px; font-weight: 600; font-size: 0.9rem;">
              Total: ${formatCurrency(item.price)}
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Notes</label>
            <input type="text" class="form-input" id="item-notes" value="${item.notes || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Image (optional)</label>
            <input type="file" class="form-input" id="item-image" accept="image/*" onchange="previewImage(event)">
            <div id="image-preview" style="margin-top: 8px;"></div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal(); render();">Cancel</button>
            <button type="submit" class="btn btn-success">✓ Mark Purchased</button>
          </div>
        </form>
      `);
      updatePriceInputState();
    }

    async function checkOffItem(e, itemId) {
      e.preventDefault();
      const list = state.lists.find(l => l.id === state.currentList.id);
      const item = list.items.find(i => i.id === itemId);
      
      const quantity = parseInt(document.getElementById('item-quantity').value) || 1;
      const inputPrice = parseFloat(document.getElementById('item-price').value) || 0;
      const priceMode = document.querySelector('input[name="price-mode"]:checked').value;
      
      item.quantity = quantity;
      item.notes = document.getElementById('item-notes').value;
      item.purchased = true;
      item.purchasedAt = new Date().toISOString();
      item.priceMode = priceMode;

      if (priceMode === 'unit') {
        item.unitPrice = inputPrice;
        item.price = inputPrice * quantity;
      } else {
        item.price = inputPrice;
        item.unitPrice = quantity > 0 ? item.price / quantity : 0;
      }

      const imageInput = document.getElementById('item-image');
      if (imageInput.files[0]) {
        item.image = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.readAsDataURL(imageInput.files[0]);
        });
      }

      list.updatedAt = new Date().toISOString();
      state.currentList = list;
      saveState();
      closeModal();
      render();
    }

    function deleteItem(listId, itemId) {
      if (confirm('Delete this item?')) {
        const list = state.lists.find(l => l.id === listId);
        list.items = list.items.filter(i => i.id !== itemId);
        list.updatedAt = new Date().toISOString();
        state.currentList = list;
        saveState();
        render();
      }
    }

    // Group Modals
    function showNewGroupModal() {
      const validGroupIds = new Set(state.groups.map(g => g.id));
      const available = state.lists.filter(l => !l.groupId || !validGroupIds.has(l.groupId));

      showModal(`
        <div class="modal-header">
          <h3 class="modal-title">Create New Group</h3>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <form onsubmit="createGroup(event)">
          <div class="form-group">
            <label class="form-label">Group Name *</label>
            <input type="text" class="form-input" id="group-name" required placeholder="e.g., Monthly Groceries">
          </div>
          <div class="form-group">
            <label class="form-label">Group Color</label>
            <input type="color" class="form-input" id="group-color" value="${DEFAULT_GROUP_COLOR}">
          </div>

          <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">

          <div class="manage-section">
            <div class="manage-section-header">
              <div class="manage-section-title">Add Selected Lists (${available.length})</div>
              <button type="button" class="select-toggle" onclick="toggleSelectAll('new-group-available-cb')">Select All</button>
            </div>

            ${available.length === 0 
              ? `<div style="color: var(--text-light); font-style: italic; font-size: 0.9rem;">No ungrouped lists</div>` 
              : available.map(list => `
                <label class="manage-list-item">
                  <input type="checkbox" class="manage-checkbox new-group-available-cb" value="${list.id}">
                  <div>
                    <div style="font-weight: 500;">${list.name}</div>
                    <div style="font-size: 0.75rem; color: var(--text-light);">${formatDate(list.createdAt)}</div>
                  </div>
                </label>
              `).join('')}

            ${available.length > 0 ? `
              <div class="text-sm" style="color: var(--text-light); margin-top: 8px;">
                Selected lists will be added when you create the group.
              </div>
            ` : ''}
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Group</button>
          </div>
        </form>
      `);
    }

    function createGroup(e) {
      e.preventDefault();
      const colorInput = document.getElementById('group-color');
      const group = {
        id: generateId(),
        name: document.getElementById('group-name').value,
        color: normalizeHexColor(colorInput ? colorInput.value : DEFAULT_GROUP_COLOR),
        createdAt: new Date().toISOString()
      };
      state.groups.push(group);
      const selectedListIds = [...document.querySelectorAll('.new-group-available-cb:checked')].map(cb => cb.value);
      if (selectedListIds.length > 0) {
        state.lists.forEach(list => {
          if (selectedListIds.includes(list.id)) {
            list.groupId = group.id;
          }
        });
      }
      saveState();
      closeModal();
      render();
    }

    function updateGroup(e, groupId) {
      e.preventDefault();
      const group = state.groups.find(g => g.id === groupId);
      group.name = document.getElementById('group-name').value;
      const colorInput = document.getElementById('group-color');
      if (colorInput) {
        group.color = normalizeHexColor(colorInput.value);
      }
      saveState();
      closeModal();
      render();
    }

    function deleteGroup(groupId) {
      if (confirm('Delete this group? Lists in this group will become ungrouped.')) {
        state.groups = state.groups.filter(g => g.id !== groupId);
        state.lists.forEach(l => {
          if (l.groupId === groupId) l.groupId = null;
        });
        saveState();
        render();
      }
    }

    // --- Export Logic Start ---

    // 1. Download Helper (Blob)
    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // 2. Reusable Selection Logic
    function getSelectedExportData() {
      const selectedListIds = [...document.querySelectorAll('.export-list-cb:checked')].map(cb => cb.value);
      const selectedGroupIds = new Set([...document.querySelectorAll('.export-group-cb:checked')].map(cb => cb.value));

      if (selectedListIds.length === 0 && selectedGroupIds.size === 0) {
        return null;
      }

      const filteredLists = state.lists.filter(l => selectedListIds.includes(l.id));

      // Auto-include groups logic
      filteredLists.forEach(list => {
          if (list.groupId) {
              selectedGroupIds.add(list.groupId);
          }
      });

      const filteredGroups = state.groups.filter(g => selectedGroupIds.has(g.id));

      return {
        lists: filteredLists,
        groups: filteredGroups
      };
    }

    // 3. Row Builders for Excel
    function buildItemsRows(lists, groups) {
      const groupMap = {};
      groups.forEach(g => groupMap[g.id] = g.name);

      const rows = [];
      lists.forEach(list => {
        const groupName = list.groupId && groupMap[list.groupId] ? groupMap[list.groupId] : 'Ungrouped';
        list.items.forEach(item => {
           const quantity = Number.isFinite(item.quantity) && item.quantity > 0 ? item.quantity : 1;
           const totalPrice = Number.isFinite(item.price) ? item.price : 0;
           const unitPrice = Number.isFinite(item.unitPrice)
             ? item.unitPrice
             : (quantity ? totalPrice / quantity : 0);
           const priceType = (item.priceMode || 'total') === 'unit' ? 'Per Unit' : 'Total';
           rows.push({
             group_name: groupName,
             list_name: list.name,
             list_created_at: formatIsoDate(list.createdAt),
             list_updated_at: formatIsoDate(list.updatedAt),
             item_name: item.name,
             quantity: quantity,
             unit_price: unitPrice,
             total_price: totalPrice, // Stored final price
             price_type: priceType,
             purchased: item.purchased,
             item_notes: item.notes || '',
             has_image: !!item.image
           });
        });
      });
      return rows;
    }

    function buildListSummaryRows(lists, groups) {
      const groupMap = {};
      groups.forEach(g => groupMap[g.id] = g.name);

      return lists.map(list => {
         const purchasedItems = list.items.filter(i => i.purchased);
         const totalSpent = purchasedItems.reduce((sum, i) => sum + i.price, 0);
         const budget = list.budget || 0;
         
         let status = 'OK';
         if (budget > 0 && totalSpent > budget) status = 'OVER BUDGET';

         return {
           group_name: list.groupId && groupMap[list.groupId] ? groupMap[list.groupId] : 'Ungrouped',
           list_name: list.name,
           created_at: formatIsoDate(list.createdAt),
           updated_at: formatIsoDate(list.updatedAt),
           budget: budget,
           purchased_items_count: purchasedItems.length,
           total_spent: totalSpent,
           status: status
         };
      });
    }

    function buildAccountingReportRows(lists) {
       return generateAccountingReport(lists); // Reusing existing helper
    }

    function buildWorkbook(lists, groups) {
      const itemsRows = buildItemsRows(lists, groups);
      const summaryRows = buildListSummaryRows(lists, groups);
      const reportRows = buildAccountingReportRows(lists);

      const wb = XLSX.utils.book_new();
      
      const wsItems = XLSX.utils.json_to_sheet(itemsRows);
      const wsSummary = XLSX.utils.json_to_sheet(summaryRows);
      const wsReport = XLSX.utils.json_to_sheet(reportRows);

      XLSX.utils.book_append_sheet(wb, wsItems, "Items");
      XLSX.utils.book_append_sheet(wb, wsSummary, "Lists Summary");
      XLSX.utils.book_append_sheet(wb, wsReport, "Accounting Report");

      return wb;
    }

    function exportToExcel(lists, groups, filename) {
      const wb = buildWorkbook(lists, groups);
      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      downloadBlob(blob, filename);
    }

    // 4. Excel Export Action Handlers
    function exportSelectedToExcel() {
      const selection = getSelectedExportData();
      if (!selection) {
        alert('Please select at least one list or group to export.');
        return;
      }
      exportToExcel(selection.lists, selection.groups, 'shopping-tracker-selected.xlsx');
      closeModal();
    }

    function exportAllToExcel() {
      exportToExcel(state.lists, state.groups, 'shopping-tracker-all.xlsx');
      closeModal(); // If modal was open via dropdown, though this button is in modal
    }

    // Export Data / UI
    function exportAll() {
      const data = {
        version: 1,
        exportedAt: new Date().toISOString(),
        lists: state.lists,
        groups: state.groups,
        accounting_report: generateAccountingReport(state.lists) 
      };
      downloadJSON(data, 'shopping-tracker-all.json');
    }

    function showExportModal() {
      showModal(`
        <div class="modal-header">
          <h3 class="modal-title">Export Data</h3>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="form-group">
          <label class="form-label">Select Lists to Export</label>
          <div class="checkbox-list">
            ${state.lists.map(list => `
              <label class="checkbox-item">
                <input type="checkbox" class="export-list-cb" value="${list.id}">
                <span>${list.name}</span>
              </label>
            `).join('')}
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Select Groups to Export</label>
          <div class="checkbox-list">
            ${state.groups.map(group => `
              <label class="checkbox-item">
                <input type="checkbox" class="export-group-cb" value="${group.id}">
                <span>${group.name}</span>
              </label>
            `).join('')}
          </div>
        </div>
        <div class="form-actions" style="flex-direction: column; align-items: stretch; gap: 8px;">
          <div style="display: flex; gap: 8px; justify-content: flex-end;">
             <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
             <button type="button" class="btn btn-primary" onclick="exportSelected()">Export Selected (JSON)</button>
          </div>
          <hr style="border: 0; border-top: 1px solid var(--border); margin: 4px 0;">
          <div style="display: flex; gap: 8px; justify-content: flex-end;">
             <button type="button" class="btn btn-success" onclick="exportSelectedToExcel()">Export Selected to Excel</button>
          </div>
        </div>
      `);
    }

    function generateAccountingReport(lists) {
      return lists.map(list => {
        const purchasedItems = list.items.filter(i => i.purchased);
        const totalSpent = purchasedItems.reduce((sum, i) => sum + i.price, 0);
        return {
          date: formatDate(list.createdAt),
          list_name: list.name,
          total_spent: totalSpent,
          budget: list.budget || 0,
          status: totalSpent > list.budget && list.budget > 0 ? "OVER BUDGET" : "OK",
          items_breakdown: purchasedItems.map(i => `${i.name} ($${i.price.toFixed(2)})`).join("; ")
        };
      });
    }

    function exportSelected() {
      const selection = getSelectedExportData();
      if (!selection) {
        alert('Please select at least one list or group to export.');
        return;
      }

      const data = {
        version: 1,
        exportedAt: new Date().toISOString(),
        lists: selection.lists,
        groups: selection.groups,
        accounting_report: generateAccountingReport(selection.lists)
      };

      downloadJSON(data, 'shopping-tracker-export.json');
      closeModal();
    }

    function downloadJSON(data, filename) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, filename);
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          if (!data.lists && !data.groups) {
            throw new Error('Invalid file format');
          }

          if (data.groups) {
            data.groups.forEach(importedGroup => {
              const existing = state.groups.find(g => g.id === importedGroup.id);
              if (existing) {
                Object.assign(existing, importedGroup);
              } else {
                state.groups.push(importedGroup);
              }
            });
          }

          if (data.lists) {
            data.lists.forEach(importedList => {
              const existing = state.lists.find(l => l.id === importedList.id);
              if (existing) {
                if (new Date(importedList.updatedAt) > new Date(existing.updatedAt)) {
                  Object.assign(existing, importedList);
                }
              } else {
                state.lists.push(importedList);
              }
            });
          }

          const validGroupIds = new Set(state.groups.map(g => g.id));
          let orphanCount = 0;
          state.lists.forEach(l => {
              if (l.groupId && !validGroupIds.has(l.groupId)) {
                  l.groupId = null;
                  orphanCount++;
              }
          });

          saveState();
          render();
          
          let msg = 'Data imported successfully!';
          if (orphanCount > 0) {
              msg += ` ${orphanCount} lists were moved to 'Ungrouped' because their group was missing.`;
          }
          alert(msg);

        } catch (err) {
          alert('Error importing file: ' + err.message);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // Initialize app
    init();
</script>
</body>
</html>
